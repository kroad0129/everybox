<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Everybox</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
        input, button { margin: 5px 0; padding: 5px; width: 100%; }
        .post, .chatroom { border: 1px solid #ddd; padding: 10px; margin-top: 10px; }
    </style>
</head>
<body>
<h1>ğŸ“¦ Everybox</h1>

<section id="loginSection">
    <h2>ğŸ” ë¡œê·¸ì¸</h2>
    <input id="email" type="email" placeholder="ì´ë©”ì¼">
    <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <button onclick="login()">ë¡œê·¸ì¸</button>
    <div style="margin: 10px 0; text-align: center;">or</div>
    <button onclick="location.href='http://localhost:8080/oauth2/authorization/kakao'" style="background-color: #FEE500; border: none; font-weight: bold;">
        ğŸŒŸ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
    </button>
    <div id="loginResult"></div>
</section>

<section id="mainSection" style="display:none">
    <h2>ğŸ‘¤ <span id="nickname"></span> ë‹˜ ë¡œê·¸ì¸ ì¤‘</h2>
    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>

    <h3>ğŸ“ ê²Œì‹œê¸€ ë“±ë¡</h3>
    <input id="postTitle" placeholder="ì œëª©">
    <input id="postContent" placeholder="ë‚´ìš©">
    <input id="postLocation" placeholder="ìœ„ì¹˜">
    <button onclick="createPost()">ë“±ë¡</button>
    <div id="postResult"></div>

    <h3>ğŸ“œ ê²Œì‹œê¸€ ëª©ë¡</h3>
    <div id="postList">Loading...</div>

    <h3>ğŸ’¬ ë‚´ ì±„íŒ…ë°©</h3>
    <div id="chatRoomList">Loading...</div>
</section>

<script>
    const BASE = 'http://localhost:8080';
    let jwt = null;
    let userId = null;
    let nickname = null;

    setInterval(() => {
        if (jwt && userId) {
            loadPosts();
            loadChatRooms();
        }
    }, 5000);

    // âœ… ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í›„ í† í°ì´ URLë¡œ ë„˜ì–´ì˜¨ ê²½ìš° ìë™ ë¡œê·¸ì¸ ì²˜ë¦¬
    window.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const tokenFromKakao = params.get("token");

        if (tokenFromKakao) {
            jwt = tokenFromKakao;
            localStorage.setItem("jwt", jwt);

            try {
                const me = await fetch(`${BASE}/auth/me`, {
                    headers: { Authorization: `Bearer ${jwt}` }
                }).then(res => res.json());

                userId = me.id;
                nickname = me.nickname;
                document.getElementById('nickname').innerText = nickname;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainSection').style.display = 'block';
                loadPosts();
                loadChatRooms();
            } catch (e) {
                console.error("í† í° ì¸ì¦ ì‹¤íŒ¨", e);
            }

            // âœ… URL ì •ë¦¬ (token ì œê±°)
            window.history.replaceState({}, document.title, "/index.html");
        }
    });

    if (jwt) autoLogin();

    async function autoLogin() {
        try {
            const me = await fetch(`${BASE}/auth/me`, {
                headers: { Authorization: `Bearer ${jwt}` }
            }).then(r => r.json());
            userId = me.id;
            nickname = me.nickname;
            document.getElementById('nickname').innerText = nickname;
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'block';
            loadPosts();
            loadChatRooms();
        } catch (e) {
            console.log("ê°€ì¥ ë°œê¸ˆì´ ì•„ë‹ˆê³  ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” JWT");
        }
    }

    async function login() {
        const res = await fetch(`${BASE}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            })
        });
        const token = await res.text();
        if (res.ok) {
            jwt = token.replace("Bearer ", "");
            localStorage.setItem("jwt", jwt);
            await autoLogin();
        } else {
            document.getElementById('loginResult').innerText = `âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${token}`;
        }
    }

    window.onload = async function() {
        jwt = localStorage.getItem("jwt");
        if (jwt) {
            try {
                const me = await fetch(`${BASE}/auth/me`, {
                    headers: { Authorization: `Bearer ${jwt}` }
                }).then(r => r.json());
                userId = me.id;
                nickname = me.nickname;
                document.getElementById('nickname').innerText = nickname;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainSection').style.display = 'block';
                loadPosts();
                loadChatRooms();
            } catch (e) {
                console.log("ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨", e);
                logout();
            }
        }
    }

    function logout() {
        jwt = null;
        userId = null;
        localStorage.removeItem("jwt");
        document.getElementById('mainSection').style.display = 'none';
        document.getElementById('loginSection').style.display = 'block';
    }

    async function createPost() {
        const res = await fetch(`${BASE}/posts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${jwt}` },
            body: JSON.stringify({
                title: document.getElementById('postTitle').value,
                content: document.getElementById('postContent').value,
                location: document.getElementById('postLocation').value
            })
        });
        if (res.ok) {
            document.getElementById('postResult').innerText = 'âœ… ê²Œì‹œê¸€ ë“±ë¡ ì™„ë£Œ!';
            loadPosts();
        } else {
            alert(await res.text());
        }
    }

    async function loadPosts() {
        const res = await fetch(`${BASE}/posts`, {
            headers: { Authorization: `Bearer ${jwt}` }
        });
        if (!res.ok) {
            document.getElementById('postList').innerText = 'âŒ ê²Œì‹œê¸€ ëª©ë¡ ë“±ë¡ ì‹¤íŒ¨';
            return;
        }
        const posts = await res.json();
        document.getElementById('postList').innerHTML = posts.map(p => `
        <div class="post">
            <b>${p.title}</b> - ${p.content} (${p.location})<br>
            ğŸ‘¤ ì‘ì„±ì: ${p.giver.nickname}<br>
            ${p.giver.id !== userId ? `<button onclick="startChat(${p.id})">ğŸ’¬ ì±„íŒ… ì‹œì‘</button>` : '<i>ë‚´ ê²Œì‹œê¸€</i>'}
        </div>
    `).join('');
    }

    async function startChat(postId) {
        const res = await fetch(`${BASE}/chatrooms`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${jwt}` },
            body: JSON.stringify({ postId })
        });
        if (res.ok) {
            const chatroom = await res.json();
            window.location.href = `chat.html?chatRoomId=${chatroom.id}&jwt=${jwt}`;
        } else {
            alert(await res.text());
        }
    }

    async function loadChatRooms() {
        const sent = await fetch(`${BASE}/chatrooms/sent?userId=${userId}`, { headers: { Authorization: `Bearer ${jwt}` } }).then(r => r.json());
        const received = await fetch(`${BASE}/chatrooms/received?userId=${userId}`, { headers: { Authorization: `Bearer ${jwt}` } }).then(r => r.json());
        const combined = [...sent, ...received];

        if (combined.length === 0) {
            document.getElementById('chatRoomList').innerHTML = "<i>ì°¸ì—¬ ì¤‘ì¸ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</i>";
            return;
        }

        document.getElementById('chatRoomList').innerHTML = combined.map(c => `
        <div class="chatroom">
            ğŸ“ ${c.post.title}<br>
            ğŸ‘¥ ìƒëŒ€: ${c.sender.id === userId ? c.receiver.nickname : c.sender.nickname}<br>
            <button onclick="goToChat(${c.id})">ì…ì¥</button>
        </div>
    `).join('');
    }

    function goToChat(chatRoomId) {
        window.location.href = `chat.html?chatRoomId=${chatRoomId}&jwt=${jwt}`;
    }
</script>
</body>
</html>