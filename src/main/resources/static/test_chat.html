<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì±„íŒ…ë°©</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #chatBox {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
        }
        .me { text-align: right; color: blue; margin: 5px; }
        .other { text-align: left; color: green; margin: 5px; }
        #status { margin-top: 5px; font-size: 14px; color: gray; }
    </style>
</head>
<body>
<h2>ğŸ’¬ ì±„íŒ…ë°©</h2>
<div id="chatBox"></div>
<input id="messageInput" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥" />
<button onclick="sendMessage()">ì „ì†¡</button>
<div id="status">â³ ì›¹ì†Œì¼“ ì—°ê²° ì¤‘...</div>

<script>
    // ì„œë²„ ì£¼ì†Œë¥¼ ì™¸ë¶€ ë„ë©”ì¸/IPë¡œ ë³€ê²½í•˜ì„¸ìš”
    const BASE = 'http://kroad0129.iptime.org:8080';

    const params = new URLSearchParams(location.search);
    const chatRoomId = params.get('chatRoomId');
    let jwt = params.get('jwt') || localStorage.getItem("test_jwt");

    if (!jwt) {
        alert("í† í° ì—†ìŒ! ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
        location.href = "test_index.html";
    }

    if (jwt.startsWith('Bearer ')) {
        jwt = jwt.substring(7);
    }

    let userId = null;
    let stomp = null;

    if (!chatRoomId || !jwt) {
        alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
        location.href = "test_index.html";
    }

    async function init() {
        try {
            // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const meRes = await fetch(`${BASE}/auth/me`, {
                headers: { Authorization: 'Bearer ' + jwt }
            });
            if (!meRes.ok) throw new Error("ì‚¬ìš©ì ì¸ì¦ ì‹¤íŒ¨");
            const me = await meRes.json();
            userId = me.id;

            // ë©”ì‹œì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            const messagesRes = await fetch(`${BASE}/api/chatrooms/${chatRoomId}/messages`, {
                headers: { Authorization: 'Bearer ' + jwt }
            });
            if (!messagesRes.ok) throw new Error("ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            const messages = await messagesRes.json();
            messages.forEach(showMessage);

            // ì›¹ì†Œì¼“ ì—°ê²° ë° êµ¬ë…
            const socket = new SockJS(`${BASE}/ws-chat`);
            stomp = Stomp.over(socket);
            stomp.connect({ Authorization: 'Bearer ' + jwt }, () => {
                document.getElementById("status").innerText = "âœ… ì—°ê²°ë¨";
                stomp.subscribe(`/sub/chat/room/${chatRoomId}`, msg => {
                    const message = JSON.parse(msg.body);
                    showMessage(message);
                });
            }, (err) => {
                document.getElementById("status").innerText = "âŒ ì—°ê²° ì‹¤íŒ¨";
                console.error("ì›¹ì†Œì¼“ ì—°ê²° ì‹¤íŒ¨", err);
            });
        } catch (e) {
            alert("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
        }
    }

    function showMessage(msg) {
        const box = document.getElementById("chatBox");
        const div = document.createElement("div");
        div.className = msg.senderId === userId ? "me" : "other";
        div.innerText = `${msg.senderName || msg.senderId}: ${msg.content}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function sendMessage() {
        const content = document.getElementById("messageInput").value.trim();
        if (!content) return;
        stomp.send(
            "/pub/chat/message",
            {},
            JSON.stringify({
                chatRoomId: chatRoomId,
                content: content
                // senderIdëŠ” ì„œë²„ì—ì„œ JWT í† í° ê¸°ë°˜ìœ¼ë¡œ ì²˜ë¦¬í•¨
            })
        );
        document.getElementById("messageInput").value = "";
    }

    init();
</script>
</body>
</html>
