<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Test Everybox</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
        input, button { margin: 5px 0; padding: 5px; width: 100%; }
        .post, .chatroom { border: 1px solid #ddd; padding: 10px; margin-top: 10px; }
        #logoutBtn { background: #bbb; color: #222; }
    </style>
</head>
<body>
<h1>ğŸ“¦ Test Everybox</h1>

<section id="loginSection">
    <h2>ğŸ” ë¡œê·¸ì¸</h2>
    <input id="email" type="email" placeholder="ì´ë©”ì¼" />
    <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
    <button onclick="login()">ë¡œê·¸ì¸</button>
    <div style="margin: 10px 0; text-align: center;">or</div>
    <button id="kakaoLoginBtn" style="background-color: #FEE500; border: none; font-weight: bold;">
        ğŸŒŸ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
    </button>
    <div id="loginResult"></div>
</section>

<section id="mainSection" style="display:none">
    <h2>ğŸ‘¤ <span id="nickname"></span> ë‹˜ ë¡œê·¸ì¸ ì¤‘</h2>
    <button id="logoutBtn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    <div id="kakaoLogout" style="margin:8px 0"></div>

    <h3>ğŸ“ ê²Œì‹œê¸€ ë“±ë¡</h3>
    <input id="postTitle" placeholder="ì œëª©" />
    <input id="postContent" placeholder="ë‚´ìš©" />
    <input id="postLocation" placeholder="ìœ„ì¹˜" />
    <button onclick="createPost()">ë“±ë¡</button>
    <div id="postResult"></div>

    <h3>ğŸ“œ ê²Œì‹œê¸€ ëª©ë¡</h3>
    <div id="postList">Loading...</div>

    <h3>ğŸ’¬ ë‚´ ì±„íŒ…ë°©</h3>
    <div id="chatRoomList">Loading...</div>
</section>

<script>
    // ì„œë²„ ì£¼ì†Œë¥¼ ì‹¤ì œ ì™¸ë¶€ ë„ë©”ì¸ ë˜ëŠ” IPë¡œ ë³€ê²½í•˜ì„¸ìš”
    const BASE = 'http://kroad0129.iptime.org:8080';

    let jwt = null;
    let userId = null;
    let nickname = null;
    let isKakao = false;

    function setJwtToken(rawToken) {
        jwt = rawToken.startsWith('Bearer ') ? rawToken.slice(7) : rawToken;
        localStorage.setItem("test_jwt", jwt);
    }

    document.getElementById('kakaoLoginBtn').onclick = function() {
        window.open(
            BASE + '/oauth2/authorization/kakao',
            'kakaoLoginPopup',
            'width=600,height=700'
        );
    };

    window.addEventListener("message", async function(event) {
        if (event.data.token) {
            setJwtToken(event.data.token);
            isKakao = true;
            localStorage.setItem("test_isKakao", "true");
            await autoLogin();
        }
    });

    async function login() {
        const res = await fetch(`${BASE}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: document.getElementById('email').value,
                password: document.getElementById('password').value
            })
        });
        const data = await res.json();
        if (data.token) {
            setJwtToken(data.token);
            isKakao = false;
            localStorage.removeItem("test_isKakao");
            await autoLogin();
        } else {
            document.getElementById('loginResult').innerText = `âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${JSON.stringify(data)}`;
        }
    }

    window.onload = async function() {
        jwt = localStorage.getItem("test_jwt");
        isKakao = localStorage.getItem("test_isKakao") === "true";
        if (jwt) await autoLogin();
    };

    async function autoLogin() {
        try {
            const me = await fetch(`${BASE}/auth/me`, {
                headers: { Authorization: 'Bearer ' + jwt }
            }).then(r => r.json());
            userId = me.id;
            nickname = me.nickname;
            document.getElementById('nickname').innerText = nickname;
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'block';
            loadPosts();
            loadChatRooms();

            setInterval(() => {
                loadPosts();
                loadChatRooms();
            }, 5000);

            if (isKakao) {
                document.getElementById('kakaoLogout').innerHTML =
                    `<a href="https://accounts.kakao.com/logout?continue=${encodeURIComponent(location.origin + '/test_index.html')}" target="_blank" style="color:#3b1e1e;font-size:14px;">ì¹´ì¹´ì˜¤ ê³„ì • ë¡œê·¸ì•„ì›ƒ(ê°•ì œ)</a>`;
            } else {
                document.getElementById('kakaoLogout').innerHTML = '';
            }
        } catch (e) {
            logout();
        }
    }

    function logout() {
        jwt = null;
        userId = null;
        nickname = null;
        localStorage.removeItem("test_jwt");
        localStorage.removeItem("test_isKakao");
        document.getElementById('mainSection').style.display = 'none';
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('kakaoLogout').innerHTML = '';
    }

    async function createPost() {
        const res = await fetch(`${BASE}/posts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + jwt },
            body: JSON.stringify({
                title: document.getElementById('postTitle').value,
                content: document.getElementById('postContent').value,
                location: document.getElementById('postLocation').value
            })
        });
        if (res.ok) {
            document.getElementById('postResult').innerText = 'âœ… ê²Œì‹œê¸€ ë“±ë¡ ì™„ë£Œ!';
            loadPosts();
        } else {
            alert(await res.text());
        }
    }

    async function loadPosts() {
        const res = await fetch(`${BASE}/posts`, {
            headers: { Authorization: 'Bearer ' + jwt }
        });
        if (!res.ok) {
            document.getElementById('postList').innerText = 'âŒ ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
            return;
        }
        const posts = await res.json();
        document.getElementById('postList').innerHTML = posts.map(p => `
            <div class="post">
                <b>${p.title}</b> - ${p.content} (${p.location})<br>
                ğŸ‘¤ ì‘ì„±ì: ${p.giverNickname || "?"}<br>
                ${p.giverId !== userId ? `<button onclick="startChat(${p.id}, ${p.giverId})">ğŸ’¬ ì±„íŒ… ì‹œì‘</button>` : '<i>ë‚´ ê²Œì‹œê¸€</i>'}
            </div>
        `).join('');
    }

    async function startChat(postId, receiverId) {
        const res = await fetch(`${BASE}/api/chatrooms`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + jwt },
            body: JSON.stringify({ postId, receiverId })
        });
        if (res.ok) {
            const chatroom = await res.json();
            window.location.href = `test_chat.html?chatRoomId=${chatroom.id}&jwt=${jwt}`;
        } else {
            alert(await res.text());
        }
    }

    async function loadChatRooms() {
        const res = await fetch(`${BASE}/api/chatrooms`, { headers: { Authorization: 'Bearer ' + jwt } });
        if (!res.ok) {
            document.getElementById('chatRoomList').innerHTML = "<i>âŒ ì±„íŒ…ë°© ëª©ë¡ ì‹¤íŒ¨</i>";
            return;
        }
        const combined = await res.json();
        if (!combined.length) {
            document.getElementById('chatRoomList').innerHTML = "<i>ì°¸ì—¬ ì¤‘ì¸ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</i>";
            return;
        }
        document.getElementById('chatRoomList').innerHTML = combined.map(c => `
            <div class="chatroom">
                ğŸ“ ê²Œì‹œê¸€: ${c.postId}<br>
                ğŸ‘¥ ìƒëŒ€: ${c.senderId === userId ? c.receiverName : c.senderName}<br>
                <button onclick="goToChat(${c.id})">ì…ì¥</button>
            </div>
        `).join('');
    }

    function goToChat(chatRoomId) {
        window.location.href = `test_chat.html?chatRoomId=${chatRoomId}&jwt=${jwt}`;
    }
</script>
</body>
</html>
