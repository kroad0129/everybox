<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ…ë°©</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #chatBox {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
        }
        .me { text-align: right; color: blue; margin: 5px; }
        .other { text-align: left; color: green; margin: 5px; }
        #status { margin-top: 5px; font-size: 14px; color: gray; }
    </style>
</head>
<body>
<h2>ğŸ’¬ ì±„íŒ…ë°©</h2>
<div id="chatBox"></div>
<input id="messageInput" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥">
<button onclick="sendMessage()">ì „ì†¡</button>
<div id="status">â³ ì›¹ì†Œì¼“ ì—°ê²° ì¤‘...</div>

<script>
    const params = new URLSearchParams(location.search);
    const chatRoomId = params.get('chatRoomId');
    let jwt = params.get('jwt') || localStorage.getItem("jwt"); // âœ… URL ìš°ì„  â†’ localStorage ë³´ì¡°

    let userId = null;
    let stomp = null;

    if (!chatRoomId || !jwt) {
        alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
        window.location.href = "index.html";
    }

    async function init() {
        try {
            // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const me = await fetch("http://localhost:8080/auth/me", {
                headers: { Authorization: `Bearer ${jwt}` }
            }).then(res => {
                if (!res.ok) throw new Error("ì‚¬ìš©ì ì¸ì¦ ì‹¤íŒ¨");
                return res.json();
            });
            userId = me.id;

            // ë©”ì‹œì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            console.log("JWT ë³´ë‚´ê¸° ì „ í™•ì¸:", jwt);
            const messages = await fetch(`http://localhost:8080/chatrooms/${chatRoomId}/messages`, {
                headers: { Authorization: `Bearer ${jwt}` }
            }).then(res => {
                if (!res.ok) throw new Error("ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
                return res.json();
            });
            messages.forEach(showMessage);

            // ì›¹ì†Œì¼“ ì—°ê²°
            const socket = new SockJS("http://localhost:8080/ws-chat");
            stomp = Stomp.over(socket);
            stomp.connect({ Authorization: `Bearer ${jwt}` }, () => {
                document.getElementById("status").innerText = "âœ… ì—°ê²°ë¨";
                stomp.subscribe(`/topic/chatroom/${chatRoomId}`, msg => {
                    const message = JSON.parse(msg.body);
                    showMessage(message);
                });
            }, (err) => {
                document.getElementById("status").innerText = "âŒ ì—°ê²° ì‹¤íŒ¨";
                console.error("ì›¹ì†Œì¼“ ì—°ê²° ì‹¤íŒ¨", err);
            });

        } catch (e) {
            alert("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
        }
    }

    function showMessage(msg) {
        const box = document.getElementById("chatBox");
        const div = document.createElement("div");
        div.className = msg.sender.id === userId ? 'me' : 'other';
        div.innerText = `${msg.sender.nickname}: ${msg.content}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function sendMessage() {
        const content = document.getElementById("messageInput").value.trim();
        if (!content) return;
        stomp.send(`/app/chat.send/${chatRoomId}`, {}, JSON.stringify({
            senderId: userId,
            content: content
        }));
        document.getElementById("messageInput").value = '';
    }

    init();
</script>
</body>
</html>
